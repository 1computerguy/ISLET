#!/usr/bin/env bash
# Global Variables
CONFIG=LOCATION

# Varables:
COUNT=0
AVAILABLE_USER=1

err(){
        MESSAGE="$1"
        logger -s -p local0.notice -t "islet" "$0: $MESSAGE"
        exit 1
}

# Retrieve globals
if [ -f $CONFIG ]; then
        source $CONFIG
        source $LIBISLET
else
        err "Error: ${CONFIG:-config} or ${LIBISLET:-libislet} not found!"
        exit 1
fi

# Override with per image configuration
CONFIGURATION="$1"
source "$CONFIG_DIR/$CONFIGURATION"

TIME=$(date +"%s")
EXPIRATION=$(date --date=@$((TIME+86400*DAYS)) +"%c")

if [ ! -r $DB ]; then
        touch $DB
	chown ${USER}:${USER} $DB
	chmod 660 $DB
fi

identify(){
	read -r -p "${WF}Are you a new or existing user?${N} ${Y}[${N}${BF}new${N}${Y}/${N}${BF}existing${N}${Y}]${N}: " CHOICE
        echo

        if [[ "$CHOICE" = "new" ]] || [[ "$CHOICE" = "existing" ]]; then
                [[ "$CHOICE" = "new" ]] && new_user
                [[ "$CHOICE" = "existing" ]] && existing_user
        else
                try_again
        fi
}

new_user(){
        notice "A temporary account will be created so that you can resume your session. Account is valid for the length of the event."
        echo

        until test $AVAILABLE_USER -ne 1
        do
                read -r -p "${WF}Choose a username${N} ${Y}[${N}${BF}a-zA-Z0-9${N}${Y}]${N}: " USERNAME
                USERNAME=$(sanitize $USERNAME)
                echo "Your username is ${MF}$USERNAME${N}"
                verify_new_user
        done

        read -r -s -p "${WF}Choose a password:${N} " PASSWORD
        echo
        read -r -s -p "${WF}Verify your password${N}: " PASSWORD_VERIFY
        echo
        verify_new_password
}

existing_user(){
        notice "Your previous account is only valid for the length of the event, after that you must create a new account"
        echo
        while test $COUNT -lt $FAILURE_COUNT
        do
                read -r -p "${WF}Username:${N} " USERNAME
                USERNAME=$(sanitize $USERNAME)
                read -r -s -p "${WF}Password:${N} " PASSWORD
                echo
                USER_SUPPLIED_PASSWORD=$(echo "$PASSWORD" | sha1sum | sed 's/ .*//')
                HASH=$(awk -F : -v user=$USERNAME '$1 == user { print $2 }' $DB)
                if [ "$USER_SUPPLIED_PASSWORD" = "$HASH" ]
                then
                        echo "${MF}Success${N}"

			# This is how we handle using the same account for multiple images
			if ! awk -F : -v user="$USERNAME" -v basename="$BASENAME" '$1 == user \
			{
				for (i=4;i<=NF;i++)
					if ($i == basename ) {
						exit 0
					}
					exit 1
			}' $DB
			then
				start_container
			fi

			# User is re-attaching to previous image
                        log "${USERNAME}: Returning user"
                        message "Welcome back!"
			is_debug "opt: start/attach ${BASENAME}.${USERNAME}"

                        docker start "${BASENAME}.${USERNAME}" > /dev/null 2>&1 && exec docker attach "${BASENAME}.${USERNAME}"
                        if [ $? -ne 0 ]; then
                                alert "Launching container failed! Please report to admins"
                                quit "Launching container failed!"
                        fi
                else
                        notice "Login Failed, try again."
                fi
                let COUNT++
        done
        alert "Too many failed attempts!"
        quit "$COUNT failed password verification attempts"
}

verify_new_user(){
        grep -w -q "$USERNAME" $DB 2>/dev/null
        if [ $? -eq 0 ]; then
                notice "User already exists! Try a different one."
                AVAILABLE_USER=1
        else
                AVAILABLE_USER=0
        fi
}

verify_new_password(){
        while [ "$PASSWORD" != "$PASSWORD_VERIFY" ]
        do
                if [ $COUNT -lt $FAILURE_COUNT ]
                then
                        notice "Passwords do not match! Try again."
                        read -r -s -p "${WF}Choose a password:${N} " PASSWORD
                        echo
                        read -r -s -p "${WF}Verify your password:${N} " PASSWORD_VERIFY
                        echo
                else
                        alert "Too many failed attempts!"
                        quit "$COUNT failed password verification attempts"
                fi
        let COUNT++
        done

        HASH=$(echo "$PASSWORD" | sha1sum | sed 's/ .*//')

        (
        flock --timeout 10 100 || quit "Couldn't obtain lock on file, try again later"
        echo "${USERNAME}:${HASH}:${TIME}" >> $DB
        ) 100>~/islet.lock

        log "${USERNAME}: Account created"
        echo "Your account will expire on ${MF}$EXPIRATION${N}"
        start_container
}

try_again(){
        read -r -p "${WF}I didn't understand your response. Would you like to try again?${N} ${Y}[${N}${BF}Y${N}${Y}/${N}${BF}N${N}${Y}]${N}: " TRY
        if [[ "$TRY" = [YyNn] ]] || [[ "$TRY" = "[yY][eE]sS]" ]] || [[ "$TRY" = "[nN][oO]" ]]; then
                [[ "$TRY" = [Yy] ]] || [[ "$TRY" = "[yY][eE][sS]" ]] && clear && identify
                [[ "$TRY" = [Nn] ]] || [[ "$TRY" = "[nN][oO]" ]] && quit "User chose to exit from try_again"
        else
                quit "User forced to exit from try_again because of invalid response to question"
        fi
}

start_container(){

	# Keep track of the user's images for re-attachment
	sed -i "/$USERNAME/s/$/:$BASENAME/" $DB

        message "Enjoy yourself!"

	NAME_OPT="--name="${BASENAME}.${USERNAME}" -t -h $HOSTNAME"
	RES_OPT="-c $CPU -m $RAM"
	NET_OPT="--net $NETWORK --dns $DNS"
	GLB_OPT="$GLOBAL_OPTIONS"
	OTH_OPT="$LOCAL_OPTIONS"
	MNT_OPT="$MOUNT"
	IMG_OPT="-i $IMAGE"
	ENV_OPT="sudo -i -u $VIRTUSER $GLOBAL_ENV $LOCAL_ENV"

	# If debugging is yes
	is_debug "opt: run $NAME_OPT $RES_OPT $NET_OPT $GLB_OPT $OTH_OPT \n\t$MNT_OPT $IMG_OPT $ENV_OPT"

	eval exec docker run "$NAME_OPT $RES_OPT $NET_OPT $GLB_OPT $OTH_OPT $MNT_OPT $IMG_OPT $ENV_OPT" $INFOLEVEL
}

trap 'echo; quit "Trap received, exiting..."' 1 2 3 20
identify
exit
